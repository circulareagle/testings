<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NaijaPro Contact Gain</title>
    <meta property="og:image" content="https://vcf.circulareagle.com/social-share-image.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        :root {
            --primary: #059669;
            --primary-dark: #064e3b;
            --vcf-red: #ef4444;
            --vcf-grey: #94a3b8;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f8fafc;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-4px); transition: transform 0.3s ease; }
        
        .input-focus:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
        }
        
        #custom-alert, #whatsapp-promo { display: none; }

        /* Pipeline Styles */
        .pipeline-container {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 999px;
            position: relative;
            overflow: hidden;
            border: 1px solid #cbd5e1;
        }
        .pipeline-fill {
            height: 100%;
            transition: width 0.8s ease-in-out;
            background: repeating-linear-gradient(
                45deg,
                var(--vcf-red),
                var(--vcf-red) 10px,
                #dc2626 10px,
                #dc2626 20px
            );
        }
        .pipeline-empty {
            background: #cbd5e1 !important;
        }
    </style>
</head>
<body class="text-slate-900 pb-28">

    <!-- Premium Header -->
    <header class="bg-white border-b border-slate-100 p-5 sticky top-0 z-40">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-800 tracking-tight text-emerald-900 flex items-center gap-2">
                    <span class="bg-emerald-600 text-white p-1 rounded-lg"><i data-lucide="briefcase" class="w-5 h-5"></i></span>
                    NaijaPro Contact Gain
                </h1>
                <p class="text-[10px] font-bold text-emerald-600/60 uppercase tracking-widest mt-1">Commercial Networking Only</p>
            </div>
            <div id="user-status" class="flex gap-2 items-center"></div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-5">

        <!-- VERIFICATION AUDIT PANEL (New - Using Firebase for Auditing) -->
        <section id="verification-audit-panel" class="mb-6 p-4 bg-white shadow-lg rounded-3xl border border-slate-100">
            <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><i data-lucide="scan-eye" class="w-5 h-5 text-indigo-500"></i> Cross-Platform Auditor</h3>
            
            <!-- User ID Display -->
            <div id="user-info" class="mb-4 p-2 bg-indigo-50 rounded-lg text-xs font-mono text-indigo-700 break-all">
                Loading User ID...
            </div>

            <!-- Status Indicator -->
            <div id="status-panel" class="p-3 rounded-xl shadow-inner mb-4 transition-all duration-300 border-l-4 border-indigo-500 bg-indigo-100">
                <div class="flex items-center space-x-3">
                    <!-- Default loading spinner -->
                    <svg id="status-icon" class="w-6 h-6 text-gray-500 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 4m0 5l-.7 4.5 1.5-1.5M4 4h5.042m-.918 21.5-4.75 4.75m0 0H7.5V11.25M10.5 11.25V7.5h-4.75M19 12h3.25m-15.5-2.75l-4.75 4.75M16.5 16.5h-4.75V19m4.75 0h-4.75M7 11v11m10-4v4"></path></svg>
                    <p id="status-message" class="text-sm font-semibold text-gray-800">System Initializing...</p>
                </div>
            </div>

            <!-- Log Panel -->
            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Firestore Activity Log (Auditable)</h4>
            <div id="log-container" class="space-y-2 max-h-40 overflow-y-auto p-3 bg-gray-50 border border-gray-200 rounded-lg">
                <p class="text-gray-400 text-xs">Waiting for logs...</p>
            </div>
            
        </section>
        
        <!-- REGISTRATION SECTION -->
        <section id="tab-home" class="tab-content active space-y-6">
            <div id="member-view" class="hidden space-y-6">
                <div class="bg-emerald-600 rounded-3xl p-8 text-white shadow-xl">
                    <h2 class="text-2xl font-bold">Welcome Back!</h2>
                    <p class="text-sm opacity-90 mt-2">You are a verified member. Access your 10 VCF files below.</p>
                    <div class="mt-6">
                         <button onclick="handleGoToFiles()" class="w-full bg-white text-emerald-700 font-bold py-4 rounded-2xl flex items-center justify-center gap-2 active:scale-[0.98] transition-all">
                            <i data-lucide="file-down" class="w-5 h-5"></i> Go to VCF Files
                        </button>
                    </div>
                </div>
            </div>

            <div id="guest-view" class="space-y-6">
                <div class="bg-emerald-50 border border-emerald-100 p-5 rounded-3xl">
                    <div class="flex gap-4">
                        <div class="bg-white p-2 h-fit rounded-xl shadow-sm">
                            <i data-lucide="lock" class="text-emerald-600 w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-emerald-900 text-sm">Restricted Access</h3>
                            <p class="text-xs text-emerald-800/70 leading-relaxed mt-1">
                                Join the directory to unlock the 10-batch VCF networking files.
                            </p>
                        </div>
                    </div>
                </div>

                <div id="form-container" class="bg-white rounded-3xl shadow-sm p-6 border border-slate-100">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-slate-800">Register Your Business</h2>
                        <p class="text-xs text-slate-400 mt-1">Join thousands of Nigerian professionals.</p>
                    </div>
                  
                    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(submitted){handleSuccess();}"></iframe>
                    
                    <!-- NOTE: Form action is preserved as requested -->
                    <form id="registration-form" class="space-y-5" 
                          action="https://docs.google.com/forms/d/e/1FAIpQLSc1Yz0jF5wANDrrZe_DgU5yMx6cWX_2BgzI8gNUHQUTe4XQCQ/formResponse" 
                          method="POST" 
                          target="hidden_iframe"
                          onsubmit="submitted=true;">
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Business/Brand Name</label>
                            <input required type="text" name="entry.403300635" placeholder="e.g. Lagos Tech Hub" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none transition-all input-focus text-sm">
                        </div>
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">WhatsApp Business Number</label>
                            <input required type="tel" name="entry.1493637334" placeholder="0801 234 5678" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none transition-all input-focus text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Category</label>
                                <select required name="entry.50410248" id="category-select" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none input-focus appearance-none">
                                    <option value="">Select Industry</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Location</label>
                                <select required name="entry.1635387367" id="state-select" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none input-focus appearance-none">
                                    <option value="">Select State</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-5 rounded-2xl hover:bg-emerald-700 shadow-xl shadow-emerald-100 active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-sm uppercase">
                            JOIN & UNLOCK FILES
                        </button>
                    </form>
                </div>
            </div>

            <div id="success-container" class="hidden space-y-6">
                <div class="bg-white rounded-3xl shadow-xl p-8 text-center border border-emerald-50">
                    <div class="bg-emerald-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="party-popper" class="text-emerald-600 w-10 h-10"></i>
                    </div>
                    <h2 class="text-2xl font-800 text-slate-800">Registration Complete!</h2>
                    <p class="text-sm text-slate-500 mt-2 leading-relaxed">Access the VCF files and complete the share task to download.</p>
                    <div class="mt-8">
                        <button onclick="handleGoToFiles()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-100 flex items-center justify-center gap-2 active:scale-[0.98] transition-all">
                            <i data-lucide="download-cloud" class="w-5 h-5"></i> Access VCF Files
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- DOWNLOADS TAB -->
        <section id="tab-download" class="tab-content space-y-5">
            <div id="download-locked" class="py-12 text-center space-y-4">
                <div class="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto">
                    <i data-lucide="lock" class="text-slate-400 w-8 h-8"></i>
                </div>
                <h3 class="font-bold text-slate-800">Files Locked</h3>
                <p class="text-xs text-slate-500 px-10">Please register your business on the Home tab to access these files.</p>
                <button onclick="switchTab('home')" class="text-emerald-600 font-bold text-sm uppercase tracking-widest">Go to Home</button>
            </div>

            <div id="download-unlocked" class="hidden space-y-5">
                <div class="px-2 flex justify-between items-end">
                    <div>
                        <div class="flex items-center gap-2 text-emerald-600 mb-1">
                            <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                            <span class="text-[10px] font-bold uppercase tracking-widest">Verified Member Access</span>
                        </div>
                        <h2 class="text-2xl font-800 text-slate-900 tracking-tight">Active Directories</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Last Update</p>
                        <p id="update-date" class="text-xs font-bold text-emerald-600">Jan 9, 2026</p>
                    </div>
                </div>
                
                <!-- 10 VCF FILE LIST -->
                <div id="vcf-list" class="space-y-4">
                    <!-- Cards generated by JS -->
                </div>

                <div class="bg-blue-50 border border-blue-100 p-5 rounded-3xl flex flex-col gap-3">
                    <div class="flex gap-4">
                        <i data-lucide="info" class="text-blue-600 shrink-0"></i>
                        <p class="text-xs text-blue-800/80 leading-relaxed">
                            A new batch of vendors is added every 24-48 hours. 
                            <a href="https://whatsapp.com/channel/0029VbC3ITpHVvTZ5btPTn0h" target="_blank" class="text-blue-700 font-bold underline">Join our Official WhatsApp Channel</a> 
                            for files upload updates without re-registering.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- SAFETY TAB -->
        <section id="tab-safety" class="tab-content space-y-6">
            <div class="bg-slate-900 p-6 rounded-3xl text-white shadow-xl">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="shield"></i> Safety & Ethics</h2>
                <p class="text-xs opacity-90 mt-2">Protect your account and your business.</p>
            </div>
            <div class="bg-white p-6 rounded-3xl border border-slate-100 space-y-5">
                <div class="flex gap-4">
                    <div class="bg-blue-50 p-2 rounded-xl"><i data-lucide="key" class="text-blue-600 w-5 h-5"></i></div>
                    <div>
                        <h4 class="text-sm font-bold text-slate-800">Enable 2FA</h4>
                        <p class="text-xs text-slate-500 mt-1">Always keep 2-Step verification active on your WhatsApp.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Alert Modal -->
    <div id="custom-alert" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-md">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
            <div id="alert-icon" class="mb-4 text-center"></div>
            <h3 id="alert-title" class="text-xl font-bold text-slate-900 mb-2 text-center">Notice</h3>
            <p id="alert-message" class="text-sm text-slate-600 mb-8 leading-relaxed text-center"></p>
            <button onclick="closeAlert()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl transition-all active:scale-95 shadow-lg shadow-emerald-200">Got it!</button>
        </div>
    </div>

    <!-- WhatsApp Channel Promo Modal -->
    <div id="whatsapp-promo" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-md">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center">
            <div class="bg-emerald-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="bell" class="text-emerald-600 w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Stay Updated!</h3>
            <p class="text-sm text-slate-600 mb-8 leading-relaxed">Join our Official WhatsApp Channel to get instant notifications whenever new VCF batches are uploaded.</p>
            <div class="space-y-3">
                <a href="https://whatsapp.com/channel/0029VbC3ITpHVvTZ5btPTn0h" target="_blank" onclick="closePromo()" class="block w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-200">Join Channel Now</a>
                <button onclick="closePromo()" class="w-full text-slate-400 font-bold py-2 text-sm">Maybe Later</button>
            </div>
        </div>
    </div>


    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-slate-100 flex justify-around items-center h-20 px-10 z-50 pb-2">
        <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center gap-1" data-tab="home">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span class="text-[10px] font-800 uppercase">Home</span>
        </button>
        <button onclick="switchTab('download')" class="nav-item flex flex-col items-center gap-1" data-tab="download">
            <i data-lucide="layers" class="w-6 h-6"></i>
            <span class="text-[10px] font-800 uppercase">Files</span>
        </button>
        <button onclick="switchTab('safety')" class="nav-item flex flex-col items-center gap-1" data-tab="safety">
            <i data-lucide="shield-check" class="w-6 h-6"></i>
            <span class="text-[10px] font-800 uppercase">Safety</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // üö® CRITICAL FIX: HARDCODED FIREBASE CONFIGURATION for GitHub Pages üö®
        // This replaces the environment variables (__app_id, etc.) that caused errors
        // outside of the Google Canvas environment, ensuring Firebase initializes correctly.
        
        const REAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAxsQWe4ZLpJpcJa1-xsoGzExLjxrGDO2k",
            authDomain: "naijapro-vcf-app.firebaseapp.com",
            projectId: "naijapro-vcf-app",
            storageBucket: "naijapro-vcf-app.firebasestorage.app",
            messagingSenderId: "562807563756",
            appId: "1:562807563756:web:3287550789100e8e738cc9"
        };
        
        // --- MAPPING TO EXISTING CODE VARIABLES ---
        // Use the actual configuration for initialization
        const firebaseConfig = REAL_FIREBASE_CONFIG;
        // Use the projectId as the App ID for consistency in Firestore paths
        const appId = REAL_FIREBASE_CONFIG.projectId; 
        // No custom token is available or needed when hosted on GitHub Pages
        const initialAuthToken = null; 

        
        // --- CONFIGURABLE DATA & CORE STATE ---
        const CONFIG = {
            updateDate: "Updated Today, 11:45 PM",
            shareTargetUnlock: 3, // Shares needed to unlock the file
            shareTargetPostDownload: 4, // Shares needed for the 'locked for tomorrow' message
            shareText: "Grow your business contacts for free on NaijaPro! Register and get the latest VCF batches here: " + window.location.href,
            vcfData: [
                { id: 1, count: 842, status: "Ongoing", file: "NaijaPro_Batch_1.vcf" },
                { id: 2, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_2.vcf" },
                { id: 3, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_3.vcf" },
                { id: 4, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_4.vcf" },
                { id: 5, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_5.vcf" },
                { id: 6, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_6.vcf" },
                { id: 7, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_7.vcf" },
                { id: 8, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_8.vcf" },
                { id: 9, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_9.vcf" },
                { id: 10, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_10.vcf" }
            ]
        };

        // --- PERSISTENCE KEYS (Still using local storage for registration state) ---
        const IS_REGISTERED_KEY = 'naijapro_user_registered';
        const TASK_PROGRESS_KEY = 'naijapro_task_progress';
        const DOWNLOADED_HISTORY_KEY = 'naijapro_downloaded_history';
        
        // --- VERIFICATION CONSTANTS & STATE ---
        const MIN_VERIFICATION_SECONDS = 6;
        let timeAppLostFocus = null; // Timestamp when visibility became 'hidden'
        let activeVerificationVcfId = null; // Which VCF ID verification is pending for
        let submitted = false;
        
        // --- FIREBASE GLOBALS ---
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // --- DOM REFERENCES ---
        const statusPanel = document.getElementById('status-panel');
        const statusIcon = document.getElementById('status-icon');
        const statusMessage = document.getElementById('status-message');
        const logContainer = document.getElementById('log-container');
        const userInfo = document.getElementById('user-info');
        
        // --- STATIC DATA ---
        const categories = ["Fashion & Lifestyle", "Gadgets & Electronics", "Real Estate", "Beauty & Skincare", "Logistics & Delivery", "Digital Assets/Crypto", "Automobiles", "Food & Groceries", "Interior Decor", "Education", "Consultancy", "Others"];
        const states = ["Lagos", "Abuja (FCT)", "Rivers", "Oyo", "Kano", "Ogun", "Enugu", "Delta", "Anambra", "Edo", "Abia", "Adamawa", "Akwa Ibom", "Bauchi", "Bayelsa", "Benue", "Borno", "Cross River", "Ebonyi", "Ekiti", "Gombe", "Imo", "Jigawa", "Kaduna", "Katsina", "Kebbi", "Kogi", "Kwara", "Nasarawa", "Niger", "Ondo", "Osun", "Plateau", "Sokoto", "Taraba", "Yobe", "Zamfara"];
        
        // --- UTILITY FUNCTIONS ---

        /** Updates the main status panel UI based on the current app state. */
        function updateStatusUI(colorClass, iconHtml, message) {
            // Update panel background and border
            statusPanel.className = statusPanel.className.replace(/bg-.*-100/g, `bg-${colorClass}-100`);
            statusPanel.className = statusPanel.className.replace(/border-l-4 border-.*-500/g, `border-l-4 border-${colorClass}-500`);
            
            // Update icon and message
            statusIcon.innerHTML = iconHtml;
            statusMessage.textContent = message;

            // Update icon classes
            const iconClasses = statusIcon.className.split(' ').filter(cls => !cls.startsWith('text-') && cls !== 'animate-spin');
            iconClasses.push(`text-${colorClass}-700`);
            if (colorClass === 'gray' || colorClass === 'indigo') iconClasses.push('animate-spin');
            
            statusIcon.className = iconClasses.join(' ');
            lucide.createIcons();
        }

        /** Formats a timestamp for display. */
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }

        /** Get VCF State: LOCKED_FOR_TASK, UNLOCKED_DOWNLOAD, LOCKED_FOR_TOMORROW (Uses localStorage) */
        function getVcfState(vcfId) {
            const downloadedHistory = JSON.parse(localStorage.getItem(DOWNLOADED_HISTORY_KEY) || '{}');
            const taskProgress = JSON.parse(localStorage.getItem(TASK_PROGRESS_KEY) || '{}');
            const progress = taskProgress[vcfId] || 0;

            if (downloadedHistory[vcfId]) {
                return { state: 'LOCKED_FOR_TOMORROW', progress };
            }
            
            if (progress >= CONFIG.shareTargetUnlock) {
                return { state: 'UNLOCKED_DOWNLOAD', progress };
            }

            return { state: 'LOCKED_FOR_TASK', progress };
        }

        // --- FIREBASE INITIALIZATION & AUTH ---

        async function initializeFirebase() {
            try {
                // Ensure config is valid before proceeding
                if (!firebaseConfig.projectId) {
                    throw new Error("Firebase configuration is missing or invalid. Check your hardcoded values.");
                }

                setLogLevel('debug'); // Enable Firestore logging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Listen for Auth State Changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfo.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        
                        // Use signInAnonymously if no custom token exists (standard for GitHub hosting)
                        if (!initialAuthToken) {
                            // We already have a user object, no need to sign in again immediately,
                            // just proceed with listeners.
                        } else {
                            // If somehow a custom token was provided, sign in with it (unlikely on GH Pages)
                            await signInWithCustomToken(auth, initialAuthToken);
                        }
                        
                        setupVisibilityListener();
                        setupLogListener();
                    } else {
                        // Attempt anonymous sign-in if no user is found
                        try {
                            await signInAnonymously(auth);
                            // onAuthStateChanged will be triggered again with the new user
                        } catch (anonError) {
                            console.error("Anonymous sign-in failed:", anonError);
                            userId = 'anonymous_user';
                            userInfo.textContent = 'Authentication Failed. Logging Disabled.';
                            isAuthReady = true;
                            updateStatusUI('red', '<i data-lucide="lock" class="w-6 h-6"></i>', 'Authentication Failed. Cannot log data.');
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                updateStatusUI('red', '<i data-lucide="alert-triangle" class="w-6 h-6"></i>', `Initialization Error: ${error.message}`);
            }
        }
        
        // --- FIREBASE LOGGING FUNCTIONS ---

        /** Gets the Firestore path for the verification logs collection. */
        function getLogCollectionRef() {
            if (!db || !userId) return null;
            // Private data storage path: /artifacts/{appId}/users/{userId}/verification_logs
            return collection(db, 'artifacts', appId, 'users', userId, 'verification_logs');
        }

        /** Logs an event to Firestore. */
        async function logEvent(type, details, duration_seconds = null, verification_status = null) {
            const logRef = getLogCollectionRef();
            if (!logRef) return;

            try {
                const logData = {
                    timestamp: serverTimestamp(),
                    type,
                    details,
                    duration_seconds,
                    verification_status,
                };
                await addDoc(logRef, logData);
                console.log(`[Firestore Log] ${type}: ${details}`);
            } catch (error) {
                console.error("Error writing document:", error);
            }
        }

        /** Sets up real-time listener for log updates. */
        function setupLogListener() {
            const logRef = getLogCollectionRef();
            if (!logRef) return;

            // NOTE: Firestore onSnapshot will run on auth change, ensuring logs are current
            const logQuery = query(logRef, orderBy('timestamp', 'desc'));

            onSnapshot(logQuery, (snapshot) => {
                logContainer.innerHTML = ''; // Clear existing logs

                if (snapshot.empty) {
                    logContainer.innerHTML = '<p class="text-gray-400 text-xs">No activity recorded yet. Initiate a share task to start tracking.</p>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const time = formatTime(data.timestamp);
                    let color = 'text-gray-800';
                    let icon = 'üü£';
                    let logDetails = data.details;

                    if (data.type === 'EXIT') {
                        color = 'text-red-600';
                        icon = 'üî¥';
                    } else if (data.verification_status === 'PASSED') {
                        icon = 'üü¢';
                        color = 'text-green-600';
                    } else if (data.verification_status === 'FAILED_QUICK_RETURN') {
                        icon = '‚ùå';
                        color = 'text-red-700';
                    } else if (data.type === 'SHARE_INITIATED') {
                        icon = '‚û°Ô∏è';
                        color = 'text-blue-600';
                        logDetails = `Share initiated for Batch ${data.vcfId}. Waiting for return...`;
                    }


                    const logEntry = `
                        <div class="text-xs p-2 bg-white rounded-lg shadow-sm border-l-4 ${data.verification_status === 'PASSED' ? 'border-green-400' : 'border-indigo-400'}">
                            <span class="font-mono text-[9px] text-gray-400">${time}</span>
                            <p class="${color} font-medium mt-1">
                                ${icon} ${logDetails}
                            </p>
                            ${data.duration_seconds ? `<p class="text-[10px] text-gray-500 mt-1">Duration Outside: <span class="font-semibold">${data.duration_seconds.toFixed(2)}s</span></p>` : ''}
                        </div>
                    `;
                    logContainer.innerHTML += logEntry;
                });
            }, (error) => {
                console.error("Error listening to logs:", error);
                logContainer.innerHTML = '<p class="text-red-500 text-xs">Error loading logs.</p>';
            });
            lucide.createIcons();
        }

        // --- VERIFICATION CORE LOGIC ---

        function processSuccessfulVerification(duration, vcfId) {
            // 1. Update localStorage progress (maintaining original state management)
            const taskProgress = JSON.parse(localStorage.getItem(TASK_PROGRESS_KEY) || '{}');
            let progress = taskProgress[vcfId] || 0;
            
            if (progress < CONFIG.shareTargetUnlock) {
                progress++;
                taskProgress[vcfId] = progress;
                localStorage.setItem(TASK_PROGRESS_KEY, JSON.stringify(taskProgress));
                
                if (progress >= CONFIG.shareTargetUnlock) {
                    showAlert('Task Completed!', `Batch ${vcfId} is now UNLOCKED!`, 'check-circle');
                } else {
                    showAlert('Sharing Progress', `Share detected (${duration.toFixed(1)}s spent)! You have completed ${progress} of ${CONFIG.shareTargetUnlock} shares for Batch ${vcfId}. Keep going!`, 'share-2');
                }
            } else {
                 showAlert('Share Acknowledged', `Your share has been detected and logged for the next batch drop. Thank you for preparing!`, 'share-2');
            }

            activeVerificationVcfId = null; // Reset
            renderVcfFiles(); // Re-render the UI to reflect new progress
        }

        function handleVisibilityChange() {
            if (!isAuthReady || !userId) {
                console.warn('Auth not ready, ignoring visibility change.');
                return;
            }

            if (document.visibilityState === 'hidden') {
                // 1. App Lost Focus (User left to go to WhatsApp, etc.)
                timeAppLostFocus = Date.now();
                
                updateStatusUI('red', '<i data-lucide="eye-off" class="w-6 h-6"></i>', `LOST FOCUS: User left at ${formatTime(timeAppLostFocus)}.`);
                
                logEvent('EXIT', `App lost focus.`);

            } else if (document.visibilityState === 'visible') {
                // 2. App Regained Focus (User returned)
                const timeAppRegainedFocus = Date.now();
                
                if (timeAppLostFocus) {
                    const durationMs = timeAppRegainedFocus - timeAppLostFocus;
                    const durationSeconds = durationMs / 1000;
                    
                    let verificationStatus;
                    let message;
                    let color;
                    let icon;

                    // 3. Perform Verification Check (Quick return detection)
                    if (durationSeconds >= MIN_VERIFICATION_SECONDS) {
                        // Verification Success
                        verificationStatus = 'PASSED';
                        message = `VERIFICATION PASSED: Task completed in ${durationSeconds.toFixed(1)}s.`;
                        color = 'green';
                        icon = '<i data-lucide="shield-check" class="w-6 h-6"></i>';

                        // IMPORTANT: Only process progress if a specific VCF verification was active
                        if (activeVerificationVcfId !== null) {
                            processSuccessfulVerification(durationSeconds, activeVerificationVcfId);
                        }

                    } else {
                        // Verification Failure (Faked completion)
                        verificationStatus = 'FAILED_QUICK_RETURN';
                        message = `VERIFICATION FAILED: Returned too quickly (${durationSeconds.toFixed(1)}s). Min time: ${MIN_VERIFICATION_SECONDS}s.`;
                        color = 'red';
                        icon = '<i data-lucide="alert-triangle" class="w-6 h-6"></i>';
                        
                        // Show immediate failure alert
                        if (activeVerificationVcfId !== null) {
                            showAlert('Security Alert: Quick Return Detected', 
                                `System detected you returned too quickly (${durationSeconds.toFixed(1)}s). Please spend at least ${MIN_VERIFICATION_SECONDS} seconds outside the app to perform the share task.`, 
                                'alert-triangle');
                        }
                    }
                    
                    updateStatusUI(color, icon, message);
                    
                    // 4. Log the Return Event with Results
                    logEvent('RETURN', message, durationSeconds, verificationStatus);

                    timeAppLostFocus = null; // Reset tracker
                    activeVerificationVcfId = null; // Reset active task
                } else {
                    // App started in background or simply regained focus without a tracked exit
                    updateStatusUI('indigo', '<i data-lucide="eye" class="w-6 h-6"></i>', 'ACTIVE: Waiting for app to lose focus...');
                    logEvent('INFO', `App active. No previous exit recorded.`);
                }
            }
        }
        
        // --- Setup Listeners ---

        function setupVisibilityListener() {
            document.addEventListener('visibilitychange', handleVisibilityChange);
            // Initial check on load
            if (document.visibilityState === 'visible') {
                updateStatusUI('indigo', '<i data-lucide="eye" class="w-6 h-6"></i>', 'ACTIVE: Waiting for app to lose focus...');
            } else {
                handleVisibilityChange();
            }
        }

        // --- RENDER FUNCTIONS ---

        function renderVcfFiles() {
            const container = document.getElementById('vcf-list');
            document.getElementById('update-date').innerText = CONFIG.updateDate;

            container.innerHTML = CONFIG.vcfData.map(vcf => {
                const percentage = (vcf.count / 1000) * 100;
                const isFirst = vcf.id === 1;
                const statusColor = isFirst && vcf.status === 'Ongoing' ? 'text-red-600 font-extrabold' : 'text-slate-400 font-bold';
                const pipelineColorClass = vcf.count > 0 ? '' : 'pipeline-empty';
                
                let pipelineText = "Empty - Not yet started";
                if(vcf.count >= 1000) pipelineText = "Full - New batch pending";
                else if(vcf.count > 700) pipelineText = "Almost Full";
                else if(vcf.count > 0) pipelineText = "Filing in progress...";

                const { state, progress } = getVcfState(vcf.id);
                let buttonHTML = '';
                
                if (state === 'LOCKED_FOR_TASK') {
                    buttonHTML = `
                        <button onclick="handleShareTaskClick(${vcf.id})" class="w-full bg-slate-100 text-slate-500 font-bold py-4 rounded-2xl flex items-center justify-center gap-3 active:bg-slate-200 transition-all text-sm group">
                           <i data-lucide="share-2" class="w-4 h-4 text-emerald-500 group-hover:scale-110 transition-transform"></i> 
                           SHARE TO UNLOCK (${progress}/${CONFIG.shareTargetUnlock})
                        </button>
                        <p class="text-[10px] text-center text-red-500 font-bold mt-2">Share this link to your WhatsApp Status to unlock!</p>
                    `;
                } else if (state === 'UNLOCKED_DOWNLOAD') {
                    buttonHTML = `
                        <button onclick="performDownload(${vcf.id}, '${vcf.file}')" class="block w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all text-sm shadow-lg shadow-emerald-200">
                            <i data-lucide="download" class="w-4 h-4 text-white"></i> DOWNLOAD BATCH ${vcf.id}
                        </button>
                        <a href="https://whatsapp.com/channel/0029VbC3ITpHVvTZ5btPTn0h" target="_blank" class="mt-2 block w-full text-center bg-blue-50 text-blue-700 font-bold py-2 rounded-2xl text-xs">
                            <i data-lucide="zap" class="w-3 h-3 inline-block mr-2"></i> Join WhatsApp Channel
                        </a>
                    `;
                } else if (state === 'LOCKED_FOR_TOMORROW') {
                    buttonHTML = `
                        <div class="space-y-3 pt-2">
                            <button onclick="handleShareTaskClick(0)" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all text-sm">
                                <i data-lucide="share-2" class="w-4 h-4 text-white"></i> SHARE TO ${CONFIG.shareTargetPostDownload} GROUPS/PEOPLE
                            </button>
                            <a href="https://whatsapp.com/channel/0029VbC3ITpHVvTZ5btPTn0h" target="_blank" class="block w-full text-center bg-blue-50 text-blue-700 font-bold py-4 rounded-2xl text-sm">
                                <i data-lucide="zap" class="w-4 h-4 inline-block mr-2"></i> Join WhatsApp Channel
                            </a>
                            <p class="text-xs text-center text-red-600/90 font-bold mt-2 leading-relaxed">
                                This file has been locked again for tomorrow's next VCF. Share to your status + ${CONFIG.shareTargetPostDownload} Groups/People to prepare.
                            </p>
                        </div>
                    `;
                }

                return `
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 space-y-4">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 items-center">
                                <div class="bg-slate-50 ${isFirst ? 'text-emerald-600' : 'text-slate-400'} p-4 rounded-2xl">
                                    <i data-lucide="file-spreadsheet" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h4 class="font-800 text-lg text-slate-800">Batch ${vcf.id} VCF</h4>
                                    <p class="text-[10px] uppercase tracking-widest ${statusColor}">${vcf.status}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-bold text-slate-800">${vcf.count}/1,000</p>
                                <p class="text-[9px] text-slate-400 uppercase">Capacity</p>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="pipeline-container">
                                <div class="pipeline-fill ${pipelineColorClass}" style="width: ${percentage}%"></div>
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${pipelineText}</p>
                                ${vcf.count > 0 ? `<span class="text-[9px] font-bold text-red-500">${Math.round(percentage)}%</span>` : ''}
                            </div>
                        </div>
                        ${buttonHTML}
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- HANDLERS ---

        function handleShareTaskClick(vcfId) {
            if (!isAuthReady || !userId) {
                showAlert('System Unavailable', 'Authentication is still loading or failed. Please wait a moment and try again.', 'alert-triangle');
                return;
            }

            // Set the active VCF ID so the visibility listener knows which task is pending
            activeVerificationVcfId = vcfId; 
            const shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(CONFIG.shareText)}`;
            
            // Log the attempt to Firestore (for auditing)
            logEvent('SHARE_INITIATED', `Share task initiated for VCF Batch ${vcfId}.`, null, null, vcfId);
            
            // Open WhatsApp (triggers document.visibilityState to 'hidden')
            window.open(shareUrl, '_blank');
            
            // Give user feedback they need to complete the action externally
            showAlert('Verification Pending', 'Please complete the WhatsApp Status share task and return to this tab immediately. Your time is now being tracked.', 'watch');
        }

        function performDownload(vcfId, filename) {
            // 1. Add to downloaded history (locks the file for tomorrow)
            const downloadedHistory = JSON.parse(localStorage.getItem(DOWNLOADED_HISTORY_KEY) || '{}');
            downloadedHistory[vcfId] = true;
            localStorage.setItem(DOWNLOADED_HISTORY_KEY, JSON.stringify(downloadedHistory));

            // 2. Simulate file download (trigger download link)
            const link = document.createElement('a');
            link.href = filename;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 3. Acknowledge and re-render to show locked state
            showAlert('Download Success', `Batch ${vcfId} VCF file downloaded successfully. File is now locked for the next drop.`, 'file-down');
            renderVcfFiles();
        }

        function handleGoToFiles() {
            // Show the promo modal before switching to the files tab
            document.getElementById('whatsapp-promo').style.display = 'flex';
        }

        function closePromo() {
            document.getElementById('whatsapp-promo').style.display = 'none';
            switchTab('download');
        }

        function checkUserStatus() {
            const isRegistered = localStorage.getItem(IS_REGISTERED_KEY);
            const guestView = document.getElementById('guest-view');
            const memberView = document.getElementById('member-view');
            const lockedDown = document.getElementById('download-locked');
            const unlockedDown = document.getElementById('download-unlocked');
            const statusDiv = document.getElementById('user-status');

            if (isRegistered) {
                guestView.classList.add('hidden');
                memberView.classList.remove('hidden');
                lockedDown.classList.add('hidden');
                unlockedDown.classList.remove('hidden');
                statusDiv.innerHTML = `<span class="h-2 w-2 bg-emerald-500 rounded-full animate-pulse"></span>
                                       <span class="text-[10px] font-bold text-emerald-600 uppercase tracking-tighter">Member</span>`;
                renderVcfFiles();
            } else {
                guestView.classList.remove('hidden');
                memberView.classList.add('hidden');
                lockedDown.classList.remove('hidden');
                unlockedDown.classList.add('hidden');
                statusDiv.innerHTML = `<span class="h-2 w-2 bg-slate-300 rounded-full"></span>
                                       <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Guest</span>`;
            }
            lucide.createIcons();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            const navBtn = document.querySelector(`[data-tab="${id}"]`);
            if(navBtn) navBtn.classList.add('active');
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function handleSuccess() {
            localStorage.setItem(IS_REGISTERED_KEY, 'true');
            document.getElementById('form-container').classList.add('hidden');
            document.getElementById('success-container').classList.remove('hidden');
            checkUserStatus();
        }

        function showAlert(title, message, iconName = 'info') {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-message').innerText = message;
            document.getElementById('alert-icon').innerHTML = `<i data-lucide="${iconName}" class="w-12 h-12 text-emerald-600 mx-auto"></i>`;
            document.getElementById('custom-alert').style.display = 'flex';
            lucide.createIcons();
        }

        function closeAlert() {
            document.getElementById('custom-alert').style.display = 'none';
        }

        // Initialize Selects
        const catSelect = document.getElementById('category-select');
        categories.forEach(c => catSelect.add(new Option(c, c)));
        const stSelect = document.getElementById('state-select');
        states.forEach(s => stSelect.add(new Option(s, s)));

        // --- Initialization ---
        
        // 1. Start Firebase
        initializeFirebase();

        // 2. Initial UI setup
        lucide.createIcons();
        checkUserStatus();

        // Initial welcome message (disclaimer)
        if(!localStorage.getItem('sawDisclaimer')) {
            setTimeout(() => {
                showAlert('Unlock Your Growth', 'Registration and a quick sharing task are required to access our community networking batches. Help us grow as you grow!', 'heart');
                localStorage.setItem('sawDisclaimer', 'true');
            }, 1000);
        }
    </script>
</body>
</html>


